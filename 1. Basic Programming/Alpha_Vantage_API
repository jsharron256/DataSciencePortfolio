# import appropriate libraries
import requests
import json
import pandas as pd
import sqlite3

# define the data retrieval function
def get_stock_data(symbol, API_KEY):
    base_url = "https://www.alphavantage.co/query?"
    function = "TIME_SERIES_DAILY" # Alterable based on the data desired. 
    output_size = "compact" # Choice b/w "compact" or "full" depending on the amt of historical data desired.
    datatype = "json"
    
    # Construct the API request URL
    api_url = f"{base_url}function={function}&symbol={symbol}&outputsize={output_size}&apikey={API_KEY}&datatype={datatype}"
    
    # Send request to API
    response = requests.get(api_url)
    
    # Parse the generated JSON response
    data = json.loads(response.text)
    
    return data

# define the data cleaning function
def clean_data(raw_data):
    
    # Convert gathered data into a Pandas DataFrame
    data = pd.DataFrame(raw_data['Time Series (Daily)']).T
    
    # Rename columns
    data.columns = ["Open", "High", "Low", "Close", "Volume"]
    
    # Convert index to datetime
    data.index = pd.to_datetime(data.index)
    
    # Convert data to numeric values
    for column in data.columns:
        data[column] = pd.to_numeric(data[column])

    return data

# define the data storage function
def store_data(data, symbol, db_path):
    conn = sqlite3.connect(db_path)
    
    # Write the data to a sqlite table
    data.to_sql(symbol, conn, if_exists='replace', index=True)

    conn.close()

# define test function / main
def main():
    
    # Define the stock symbol and the API key
    symbol = "stock_ticker"
    API_KEY = "API_KEY"
    db_path = "stock_data.db"

    # Collect data
    raw_data = get_stock_data(symbol, API_KEY)

    # Clean data
    data = clean_data(raw_data)

    # Store data
    store_data(data, symbol, db_path)
    
if __name__ == "__main__":
    main()
